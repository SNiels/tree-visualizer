!function(t){function e(e){t(e.container).append('<div id="tv-error" style="display: none"><p></p></div>'),c=t("#tv-error");var i=[],n=[];if(e.normalView){x=!0,t(e.container).append('<div id="tree-visualizer" style="display: none"></div>'),h=t("#tree-visualizer");var o='<div class="tree" style="font-size: '+e.fontSize+'px;"></div><aside class="tooltip" style="display: none"><ul></ul><button>&#10005;</button></aside>';e.fsView&&(o+='<button class="tv-show-fs">Fullscreen</button>'),h.append(o),m=h.find(".tree"),w=h.find(".tooltip"),i.push("#tree-visualizer .tree"),n.push("#tree-visualizer .tooltip")}if(e.fsView){V=!0,t("body").append('<div id="fs-tree-visualizer" style="display: none"></div>'),f=t("#fs-tree-visualizer");var a='<div class="tree size0"></div><aside class="tooltip" style="display: none"><ul></ul><button>&#10005;</button></aside><div class="zoom-opts"><button class="zoom-out">-</button><button class="zoom-default">Default</button><button class="zoom-in">+</button><button class="close">&#10005;</button></div>';f.hide().append(a),v=f.find(".tree"),b=f.find(".tooltip"),y=f.find(".zoom-opts"),i.push("#fs-tree-visualizer .tree"),n.push("#fs-tree-visualizer .tooltip")}C=e.advanced,""!=e.fsBtn&&t(e.fsBtn).addClass("tv-show-fs"),g=t(i.join()),z=t(n.join())}function i(e){t.ajax({type:"GET",url:e,dataType:"xml"}).done(function(t){null==t?p("Your XML appears to be empty or not in a compatible format."):n(t)}).fail(function(t,e,i){p(e+": "+i)})}function n(e){var i=t(e);u(),g.html(o(i.find("node").first())),z.children("ul").empty(),a()}function o(e){var i=t("<ol/>");return e.each(function(e,n){for(var a=t('<li><a href="#"></a></li>'),s=0,d=n.attributes.length,l=null;d>s;s++)l=n.attributes[s],a.attr("data-"+l.nodeName,l.value.replace(/^\s(.+)/g,"$1"));t(this).children("node").length&&a.append(o(t(this).children("node"))),i.append(a)}),i}function a(){g.find("a").each(function(){var e=t(this),i=e.parent("li");i.data("rel")&&(e.append("<span>"+i.data("rel")+"<span>"),i.data("index")&&e.append("<span>"+i.data("index")+"</span>")),i.data("pt")?i.data("index")?e.children("span:last-child").append(":"+i.data("pt")):e.append("<span>"+i.data("pt")+"</span>"):i.data("cat")&&(i.data("index")?e.children("span:last-child").append(":"+i.data("cat")):e.append("<span>"+i.data("cat")+"</span>")),e.is(":only-child")&&(i.data("lemma")&&i.append("<span>"+i.data("lemma")+"</span>"),i.data("word")&&i.append("<span><em>"+i.data("word")+"</em></span>")),e.addClass("only-child")}),g.find("li:only-child").addClass("only-child"),g.find("li:first-child").addClass("first-child"),g.find("li:last-child").addClass("last-child"),x&&h.show()}function s(){W>=H.length-1?y.find("button.zoom-in").prop("disabled",!0):0>=W?y.find("button.zoom-out").prop("disabled",!0):y.find("button").prop("disabled",!1)}function d(){v.css("fontSize",H[W]+"px")}function l(){var e;"undefined"!=typeof v&&v.is(":visible")?e=v:"undefined"!=typeof m&&m.is(":visible")&&(e=m);var i=e.find("a.hovered");if(i.length){var n=e.next(".tooltip"),o=i.offset(),a=e.offset(),s=t(window),d={top:o.top,right:s.outerWidth()-(o.left+i.outerWidth()),bottom:s.outerHeight()-(o.top+i.outerHeight()),left:o.left,w:i.outerWidth(),h:i.outerHeight()},l={top:a.top,right:s.outerWidth()-(a.left+e.outerWidth()),bottom:s.outerHeight()-(a.top+e.outerHeight()),left:a.left,w:e.outerWidth(),h:e.outerHeight()};n.css({left:parseInt(d.left+d.w/2-n.outerWidth()/2+7.5,10),top:parseInt(d.top-n.outerHeight()-24,10)-s.scrollTop()}),console.log(s.scrollTop()),d.left+d.w/2<l.left||d.right+d.w/2<l.right||d.top+d.h/2<l.top||d.bottom+d.h<l.bottom?n.fadeOut(400):n.show()}}function r(){var e=parseInt(v.css("paddingRight"),10)||0,i=parseInt(v.css("paddingTop"),10)||0,n=parseInt(f.css("paddingRight"),10)||0,o=parseInt(f.css("paddingTop"),10)||0,a=v.children("ol"),s=t(window);v.css({width:a.outerWidth()+2*e,height:a.outerHeight()+2*i,"max-width":s.width()-2*n,"max-height":s.height()-2*o}),v.css({"margin-left":(s.width()-2*n-v.outerWidth())/2,"margin-top":(s.height()-2*o-v.outerHeight())/2})}function p(t){c.children("p").text(t).parent().fadeIn(250),x&&(m.scrollLeft(0),h.find(".tv-show-fs").prop("disabled",!0))}function u(){c.hide(),x&&h.find(".tv-show-fs").prop("disabled",!1)}var f,h,c,v,m,b,w,g,z,y,x,V,C,H=[8,10,12,14,16,20],W=Math.round(H.length/2);t.treeVisualizer=function(n,o){var a=t.extend({},t.treeVisualizer.defaults,o);(a.normalView||a.fsView)&&t(a.container).length?(e(a),i(n),t(".tv-show-fs").click(function(t){z.css("top","-100%").children("ul").empty(),"undefined"!=typeof m&&m.find("a").removeClass("hovered"),s(),d(),f.fadeIn(250),r(),t.preventDefault()}),g.scroll(function(){l()}),t(window).scroll(function(){l()}),V&&(y.find("button").click(function(){var e=t(this);e.is(".close")?f.fadeOut(250,function(){v.find("a").removeClass("hovered")}):(e.is(".zoom-in")?W++:e.is(".zoom-out")?W--:e.is(".zoom-default")&&(W=Math.round(H.length/2)),s(),d(),r(),l())}),window.onresize=r),g.on("click","a",function(e){var i=t(this),n=i.parent("li"),o=n.data(),a=i.closest(".tree"),s=a.find("a"),d=a.next(".tooltip").children("ul");d.empty(),s.removeClass("hovered"),i.addClass("hovered");var r;for(r in o)o.hasOwnProperty(r)&&t("<li>",{html:"<strong>"+r+"</strong>: "+o[r]}).prependTo(d);l(),e.preventDefault()}),z.find("button").click(function(){var e=t(this),i=e.parent(".tooltip"),n=i.prev(".tree"),o=n.find("a");i.fadeOut(250),o.removeClass("hovered")})):console.error("Cannot initialize Tree Visualizer: either the container does not exist, or you have set both normal and fullscreen view to false, which does not make sense.")},t.treeVisualizer.defaults={normalView:!0,fsView:!0,advanced:!1,fontSize:12,fsBtn:"",container:"body"}}(jQuery);
